<!DOCTYPE html>
<html lang="en-us">
    <head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>How to easily upgrade, downgrade, and migrate Go modules &middot; Zara&#39;s Code Adventures</title>

	
	<link rel="stylesheet" href="/blog/css/style.css">

	<link rel="preload" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700" as="style"
		onload="this.onload=null;this.rel='stylesheet'">
	<noscript>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
	</noscript>
	
	
	<link rel="icon" type="image/png" href="/blog/images/logo.png">
	
	
	<link rel="preload" href="/blog/css/styling.css" as="style"
		onload="this.onload=null;this.rel='stylesheet'">
	<noscript>
		<link rel="stylesheet" href="/blog/css/styling.css">
	</noscript>
	
	
	<link rel="preload" href="/blog/css/prism.css" as="style"
		onload="this.onload=null;this.rel='stylesheet'">
	<noscript>
		<link rel="stylesheet" href="/blog/css/prism.css">
	</noscript>
	
	
	<script type="text/javascript" src="/blog/scripts/prism.js" async></script>
	
	

	
	<link href="" rel="alternate"
		type="application/rss+xml" title="Zara&#39;s Code Adventures" />
</head>
    <body>
        <nav class="nav">
	<div class="nav-container">
		<a href="/blog/">
			<div class="nav-header">
				<img class="nav-logo" src="https://zaracooper.github.io/blog/images/logo.png" />
				<h1 class="nav-title">&nbsp;&nbsp;Zara&#39;s Code Adventures</h1>
			</div>
		</a>
	</div>
</nav>
        

<main>
    <div class="post">
        <img src="go-upgrades-downgrades.jpg" /> 
        
        <div class="post-info">
    <span>Written by</span>
        Zara Cooper
        <br>
        <span>on&nbsp;</span><time datetime="2020-03-05 02:03:53 &#43;0300 EAT">March 5, 2020</time>
</div> 
        
        <h1 class="post-title">How to easily upgrade, downgrade, and migrate Go modules</h1>
<div class="post-line"></div> 
        
         
        
        

<p>Go 1.14 is officially out and module support is now <a href="https://blog.golang.org/go1.14">production ready</a>. This is an opportune time to migrate to modules. With a large codebase, upgrading, downgrading, and migrating to modules may seem like a daunting task because so many changes have to be made to the code. In this tutorial, with the help of <a href="https://github.com/zaracooper/recipepuppy">this Recipe Puppy Go client module</a>, I&rsquo;ll walk through how to make module upgrades, downgrades, and migrations hassle-free.</p>

<h2 id="what-s-covered">What&rsquo;s covered:</h2>

<ol>
<li><a href="#installing-the-mod-tool">Installing the <code>mod</code> tool</a></li>
<li><a href="#upgrades-and-migrations">Upgrades and migrations</a></li>
<li><a href="#downgrades">Downgrades</a></li>
<li><a href="#upgrading-dependencies">Upgrading dependencies</a></li>
<li><a href="#downgrading-dependencies">Downgrading dependencies</a></li>
</ol>

<h2 id="installing-the-mod-tool">Installing the <code>mod</code> tool</h2>

<p>The <a href="https://github.com/marwan-at-work/mod"><code>mod</code> tool</a> makes upgrades and downgrades simple and quick. To install it:</p>

<ol>
<li>Set <code>$GOPATH</code> if it has no value.</li>
<li>Add <code>$GOPATH\bin</code> to your <code>$PATH</code>.</li>
<li>Set <code>GO111MODULE</code> to <code>on</code>. Alternatively, you could set this value when installing the tool.</li>

<li><p>Run:</p>

<pre><code class="language-bash">go get github.com/marwan-at-work/mod
</code></pre></li>
</ol>

<h2 id="upgrades-and-migrations">Upgrades and migrations</h2>

<p>When using Go modules, any backward compatibility breaking changes require a major version upgrade. Migrating to modules is considered a breaking change and requires an upgrade of the major version. Other backward-incompatible changes can include deleting and modifying exported types, functions, constants, methods, and variables <a href="https://blog.merovius.de/2015/07/29/backwards-compatibility-in-go.html">among other things</a>. It&rsquo;s important to have a clear picture of what backward-incompatible changes are to be made before deciding to upgrade.</p>

<p>In the case of the Recipe Puppy client, we&rsquo;re going to change some function signatures in <a href="https://github.com/zaracooper/recipepuppy/tree/v1.0.0"><code>v1</code></a> from:</p>

<pre><code class="language-go">func FindRecipes(searchTerm string) ([]Recipe, error) {
    ...
}

func FindRecipesByIngredient(ingredient string) ([]Recipe, error) {
    ...
}
</code></pre>

<p>to this in the next version:</p>

<pre><code class="language-go">// this is a breaking change because the function arguments have been modified
func FindRecipes(recipeTitles []string, page int) ([]Recipe, error) {
    ...
}

// this is a new feature
func FindRecipesWithIngredients(recipeTitles []string, ingredients []string, page int) ([]Recipe, error) {
    ...
}

// this is a breaking change because the function arguments have been modified
func FindRecipesByIngredients(ingredients []string, page int) ([]Recipe, error) {
    ...
}
</code></pre>

<p>To upgrade to a new version:</p>

<ol>
<li>Identify your next major version eg. <code>v1</code> → <code>v2</code>, <code>v4</code> → <code>v5</code>. In this instance, I&rsquo;m upgrading from <code>v1</code> to <code>v2</code>.</li>

<li><p>Create a space for the new changes. This is done to comply with <a href="https://zaracooper.github.io/blog/posts/go-module-tidbits/#13-semantic-import-versioning"><strong>semantic import versioning</strong></a>. I&rsquo;m using the <strong>major subdirectory</strong> method to release my <code>v2</code>+ module. So I&rsquo;ll create a new <code>v2</code> directory at the module root. If you are using the <strong>major branch</strong> method, create a new branch.</p>

<pre><code class="language-bash">mkdir v2
</code></pre></li>

<li><p>Copy Go source files and the go.mod file from the current version to the new directory.</p>

<pre><code class="language-bash">cp *.go v2/
cp go.mod v2/
</code></pre></li>

<li><p>Upgrade to the new version. The <code>mod</code> tool will change all module and import paths in the Go source files and the go.mod to reflect the new major version number. In this case, the import path <code>github.com/zaracopper/recipepuppy</code> in <code>v1</code> will change to <code>github.com/zaracooper/recipepuppy/v2</code> for <code>v2</code> in the files copied over.</p>

<pre><code class="language-bash">cd v2
mod upgrade
</code></pre></li>

<li><p>Add the <a href="https://github.com/zaracooper/recipepuppy/blob/v2.0.0/v2/api.go">compatibility breaking changes</a> to the source code. I added the aforementioned changes.</p></li>

<li><p>Write/modify <a href="https://github.com/zaracooper/recipepuppy/blob/v2.0.0/v2/api_test.go">tests</a> to cover the breaking changes. Run the tests to make sure that they pass and that the code works as expected.</p></li>

<li><p>Tag the release if everything is stable. If you&rsquo;d like more room to experiment with and test the new changes, tag it as a pre-release version. Use the <code>-m</code> flag to provide an optional message describing the changes made to accompany your tag.</p>

<pre><code class="language-bash">git tag v2
</code></pre></li>

<li><p>Push the tag.</p>

<pre><code class="language-bash">git push origin v2
</code></pre></li>
</ol>

<p>Github releases are different from Git tags. Github treats your tag as the title of the equivalent release. If you&rsquo;re using Github, you can add the tag version on Github and even modify the release message.</p>

<p><img src="tag-display-github.png" alt="Tag names and tag versions" /></p>

<p><img src="edit-github.png" alt="Modify tag names and tag versions" /></p>

<h2 id="downgrades">Downgrades</h2>

<p>Module downgrades can be a good idea in some situations. For example, maybe a severe bug was part of a new tag or maybe a developer is having second thoughts about making compatibility breaking changes or an incorrectly named tag was pushed to the origin repository. In most cases, however, downgrading a module would be a terrible idea because it may involve deleting a published tag and users may have already started consuming it. The best option when dealing with some of the aforementioned scenarios would be to publish a new tag or send out a patch.</p>

<p>That being said, if the tag hasn&rsquo;t yet been published or consumption of the new release is limited, then downgrading a module would be okay. Downgrading involves:</p>

<ol>
<li><p>Deleting the tag locally if one was already created.</p>

<pre><code class="language-bash">git tag -d v2
</code></pre></li>

<li><p>Downgrading the module. This will modify the module and import paths by removing the versions number from them or replacing it with the previous version number. For example, when downgrading the new <code>v2</code>, module paths will change from <code>github.com/zaracooper/recipepuppy/v2</code> to <code>github.com/zaracooper/recipepuppy</code>.</p>

<pre><code class="language-bash">mod downgrade
</code></pre></li>
</ol>

<h2 id="upgrading-dependencies">Upgrading dependencies</h2>

<p>New versions of dependencies are released constantly. In most cases, it&rsquo;s always advisable to upgrade to take advantage of new features and keep up with patches. In large codebases, it may be daunting to upgrade if a dependency is used in multiple places. It&rsquo;s even trickier when trying to upgrade more than one dependency at a time. Since it can get pretty complicated, some maintainers even opt for phased migrations when deciding to upgrade. An easy way to minimize the work involved is to change module and import paths in one fowl swoop. For example, to upgrade the <code>github.com/jarcoal/httpmock</code> test dependency when a <code>v2</code> version comes out, all I&rsquo;d have to do is:</p>

<pre><code class="language-bash">mod upgrade --mod-name=github.com/jarcoal/httpmock
</code></pre>

<h2 id="downgrading-dependencies">Downgrading dependencies</h2>

<p>Sometimes using a new dependency may not work out and you may need to use a previous version that had worked better. A faster way to downgrade a dependency is to use <code>mod downgrade</code>. If I decided to downgrade <code>github.com/jarcoal/httpmock</code>, all I&rsquo;d have to do is:</p>

<pre><code class="language-bash">mod downgrade --mod-name=github.com/jarcoal/httpmock
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>Module support has been a godsend. However, it can involve a ton of work when it comes to enforcing semantic import versioning when making and using <code>v2</code>+ modules. The <code>mod</code> command is an amazing tool that makes migrations, downgrades, and upgrades faster and less taxing. I hope this was insightful.</p>

<h2 id="credits">Credits</h2>

<p><a href="https://github.com/egonelbre/gophers">Gophers</a></p>
 
        
        
    </div>

    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "zaracooper-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <div class="pagination">
        <a href="/blog/posts/go-module-tidbits/" class="left arrow">&#8592;</a>

        <a href="#" class="top">Top</a>
    </div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2020-03-05 07:12:31.916165 &#43;0300 EAT m=&#43;0.254006155">2020</time> Zara. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
